<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß™ Test Local - JARVIS V2</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1a1a2e;
      color: white;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #ffd700; }
    .test-section {
      background: rgba(27, 27, 27, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 1px solid rgba(255, 140, 0, 0.3);
    }
    button {
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: black;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      transform: scale(1.05);
    }
    .result {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: #4ade80; }
    .error { color: #ef4444; }
    .info { color: #60a5fa; }
    .link {
      color: #ffd700;
      text-decoration: none;
      font-weight: bold;
    }
    .link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>üß™ Test Local JARVIS V2</h1>
  <p>Utilisez cette page pour tester votre application localement avant de d√©ployer.</p>

  <div class="test-section">
    <h2>üìÅ 1. V√©rification des Fichiers</h2>
    <p>V√©rifiez que tous les fichiers sont pr√©sents :</p>
    <button onclick="checkFiles()">V√©rifier les fichiers</button>
    <div id="files-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>üîó 2. Test du Webhook n8n</h2>
    <p>Testez la connexion au webhook n8n :</p>
    <button onclick="testWebhook()">Tester webhook (texte)</button>
    <button onclick="testWebhookAudio()">Simuler audio</button>
    <div id="webhook-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>üé§ 3. Test du Microphone</h2>
    <p>V√©rifiez que le navigateur peut acc√©der au microphone :</p>
    <button onclick="testMicrophone()">Tester microphone</button>
    <div id="mic-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>üì± 4. Test PWA</h2>
    <p>V√©rifiez que le Service Worker fonctionne :</p>
    <button onclick="testPWA()">Tester PWA</button>
    <div id="pwa-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>üöÄ 5. Ouvrir l'Application</h2>
    <p>Pr√™t √† tester l'application compl√®te ?</p>
    <a href="index.html" class="link">‚Üí Ouvrir JARVIS V2</a>
  </div>

  <script>
    const WEBHOOK_URL = "https://n8n.srv846378.hstgr.cloud/webhook/77a6a624-93e6-463e-a1f4-5185239570e2";

    function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      el.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    function checkFiles() {
      const resultDiv = document.getElementById('files-result');
      resultDiv.innerHTML = '<div class="info">V√©rification en cours...</div>';

      const requiredFiles = [
        'index.html',
        'manifest.json',
        'sw.js',
        'icon.png',
        'README.md',
        'GUIDE-DEPLOIEMENT.md',
        'N8N-CONFIG.md'
      ];

      let html = '<div class="success">‚úì Page de test charg√©e</div>';
      html += '<div class="info">Fichiers requis :</div>';

      requiredFiles.forEach(file => {
        html += `<div class="info">  - ${file}</div>`;
      });

      html += '<div class="info"><br>Note : Impossible de v√©rifier l\'existence des fichiers en JavaScript pur.</div>';
      html += '<div class="info">V√©rifiez manuellement avec : <code>ls -la</code></div>';

      resultDiv.innerHTML = html;
    }

    async function testWebhook() {
      const resultDiv = document.getElementById('webhook-result');
      resultDiv.innerHTML = '';
      log('webhook-result', 'üîÑ Envoi de la requ√™te test au webhook...', 'info');

      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'Test depuis page de test locale',
            timestamp: new Date().toISOString()
          })
        });

        log('webhook-result', `üìä Status: ${response.status} ${response.statusText}`, 'info');

        const text = await response.text();
        log('webhook-result', `üì® R√©ponse brute: ${text.substring(0, 200)}...`, 'info');

        try {
          const data = JSON.parse(text);
          log('webhook-result', `‚úÖ R√©ponse JSON valide`, 'success');
          log('webhook-result', `üí¨ Reply: ${data.reply || 'Aucune r√©ponse'}`, 'success');
        } catch (e) {
          log('webhook-result', `‚ö†Ô∏è R√©ponse non-JSON (normal si workflow non configur√©)`, 'info');
        }

        log('webhook-result', `‚úÖ Webhook accessible et fonctionnel !`, 'success');

      } catch (error) {
        log('webhook-result', `‚ùå Erreur: ${error.message}`, 'error');
        log('webhook-result', `V√©rifiez votre connexion Internet`, 'error');
      }
    }

    async function testWebhookAudio() {
      const resultDiv = document.getElementById('webhook-result');
      resultDiv.innerHTML = '';
      log('webhook-result', 'üîÑ Simulation d\'envoi audio...', 'info');

      // Cr√©er un faux base64 audio (juste pour tester le format)
      const fakeAudio = 'R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            audio: fakeAudio,
            mimeType: 'audio/webm',
            timestamp: new Date().toISOString()
          })
        });

        log('webhook-result', `üìä Status: ${response.status}`, 'info');

        if (response.status === 200) {
          log('webhook-result', `‚úÖ Format audio accept√© par le webhook`, 'success');
        } else {
          log('webhook-result', `‚ö†Ô∏è R√©ponse: ${response.status}`, 'info');
        }

        log('webhook-result', `Note: Pour tester r√©ellement, configurez Whisper dans n8n`, 'info');

      } catch (error) {
        log('webhook-result', `‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function testMicrophone() {
      const resultDiv = document.getElementById('mic-result');
      resultDiv.innerHTML = '';
      log('mic-result', 'üé§ Demande d\'acc√®s au microphone...', 'info');

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log('mic-result', '‚úÖ Permission accord√©e !', 'success');
        log('mic-result', `üìä Tracks: ${stream.getTracks().length}`, 'success');

        // Tester MediaRecorder
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? 'audio/webm;codecs=opus'
          : MediaRecorder.isTypeSupported('audio/webm')
          ? 'audio/webm'
          : 'audio/mp4';

        log('mic-result', `üéµ Format support√©: ${mimeType}`, 'success');

        const recorder = new MediaRecorder(stream, { mimeType });
        log('mic-result', `‚úÖ MediaRecorder cr√©√© avec succ√®s`, 'success');

        // Arr√™ter le stream
        stream.getTracks().forEach(track => track.stop());
        log('mic-result', `‚úÖ Test microphone r√©ussi !`, 'success');
        log('mic-result', `‚Üí Le mode vocal devrait fonctionner`, 'success');

      } catch (error) {
        log('mic-result', `‚ùå Erreur: ${error.message}`, 'error');

        if (error.name === 'NotAllowedError') {
          log('mic-result', `Veuillez autoriser l'acc√®s au microphone`, 'error');
        } else if (error.name === 'NotFoundError') {
          log('mic-result', `Aucun microphone d√©tect√©`, 'error');
        } else {
          log('mic-result', `Erreur: ${error.name}`, 'error');
        }
      }
    }

    async function testPWA() {
      const resultDiv = document.getElementById('pwa-result');
      resultDiv.innerHTML = '';

      log('pwa-result', 'üì± Test de la PWA...', 'info');

      // Test Service Worker
      if ('serviceWorker' in navigator) {
        log('pwa-result', '‚úÖ Service Worker support√©', 'success');

        try {
          const registration = await navigator.serviceWorker.register('sw.js');
          log('pwa-result', `‚úÖ Service Worker enregistr√©`, 'success');
          log('pwa-result', `Scope: ${registration.scope}`, 'info');
        } catch (error) {
          log('pwa-result', `‚ö†Ô∏è Erreur d'enregistrement: ${error.message}`, 'error');
        }
      } else {
        log('pwa-result', '‚ùå Service Worker non support√©', 'error');
      }

      // Test Manifest
      const manifestLink = document.querySelector('link[rel="manifest"]');
      if (manifestLink) {
        log('pwa-result', `‚úÖ Manifest trouv√©: ${manifestLink.href}`, 'success');
      } else {
        log('pwa-result', `‚ö†Ô∏è Pas de manifest sur cette page`, 'info');
      }

      // Test Installation
      if (window.matchMedia('(display-mode: standalone)').matches) {
        log('pwa-result', '‚úÖ Application d√©j√† install√©e !', 'success');
      } else {
        log('pwa-result', 'üì± Pas encore install√©e (normal)', 'info');
      }

      log('pwa-result', '‚úÖ Tests PWA termin√©s', 'success');
    }
  </script>
</body>
</html>
